name: Deploy to EC2 + Cloudflare Tunnel

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Copy files to EC2
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        source: "."
        target: "~/weather-bot"

    - name: Deploy on EC2 via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          cd ~/weather-bot

          echo "ğŸ”§ å»ºç«‹ .env"
          echo "${{ secrets.WEATHERBOTENV }}" > .env

          echo "ğŸ³ å®‰è£ Dockerï¼ˆå¦‚å°šæœªå®‰è£ï¼‰"
          if ! command -v docker &> /dev/null; then
            sudo apt update
            sudo apt install -y docker.io
            sudo usermod -aG docker $USER
            newgrp docker
          fi

          echo "ğŸ§¼ ç§»é™¤èˆŠå®¹å™¨ï¼ˆå¦‚æœæœ‰ï¼‰"
          docker stop weather-bot || true
          docker rm weather-bot || true

          echo "ğŸ“¦ å»ºç«‹ Docker image"
          docker build -t weather-bot .

          echo "ğŸš€ å•Ÿå‹•å®¹å™¨"
          docker run -d --network host --env-file .env --name weather-bot weather-bot

          echo "â˜ï¸ å®‰è£ cloudflaredï¼ˆå¦‚å°šæœªå®‰è£ï¼‰"
          if ! command -v cloudflared &> /dev/null; then
            curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
            chmod +x cloudflared
            sudo mv cloudflared /usr/local/bin
          fi

          echo "ğŸ” å»ºç«‹ systemd æœå‹™"
          sudo tee /etc/systemd/system/cloudflared.service > /dev/null << EOF
          [Unit]
          Description=Cloudflare Tunnel
          After=network.target

          [Service]
          ExecStart=/usr/local/bin/cloudflared tunnel --url http://localhost:8000
          Restart=always
          User=ubuntu
          Environment=HOME=/home/ubuntu

          [Install]
          WantedBy=multi-user.target
          EOF

          echo "âœ… å•Ÿå‹• cloudflared systemd"
          sudo systemctl daemon-reexec
          sudo systemctl daemon-reload
          sudo systemctl enable cloudflared
          sudo systemctl restart cloudflared

          echo "ğŸ‰ å…¨éƒ¨éƒ¨ç½²å®Œæˆï¼"
          
    - name: Start cloudflared quick tunnel
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          echo "ğŸš€ å•Ÿå‹• cloudflared quick tunnel"
          sudo pkill cloudflared || true
          nohup cloudflared tunnel --url http://localhost:8000 > ~/cloudflared.log 2>&1 &
          echo "â³ ç­‰å¾… tunnel å»ºç«‹ä¸­..."
          sleep 10
          echo "ğŸ” æŸ¥è©¢ HTTPS ç¶²å€ï¼š"
          grep -aEo "https://[a-zA-Z0-9.-]+\.trycloudflare\.com" ~/cloudflared.log || echo "âŒ é‚„æ˜¯æŠ“ä¸åˆ° tunnel ç¶²å€ï¼Œè«‹ç™»å…¥ EC2 ç”¨ cat ~/cloudflared.log æŸ¥çœ‹"
    
